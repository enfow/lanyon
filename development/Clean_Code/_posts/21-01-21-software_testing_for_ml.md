---
layout: post
title: "Testings for Machine Learning"
category_num : 1
---

# Testings for Machine Learning

- 머신러닝 리서치 엔지니어로 일하면서 느낀 Software Testing의 필요성에 대해 정리해보았습니다.
- Reference
    - Test-Driven Development: By Example by Kent Beck
    - [TestDrivenDevelopment](<https://martinfowler.com/bliki/TestDrivenDevelopment.html>) by Martin Fowler
- Update at: 2021.01.21

## Why Software Testing?

Software Testing이란 작성한 코드가 원하는대로 정확히 동작하는지 검증하는 작업을 말하는데, 최근에는 PyTest와 같은 Test Tool을 사용하여 자동화하는 것이 일반적이다. 이렇게 Test를 자동화하게 되면 어떤 함수에서 어떤 문제가 있는지 한 번에 알 수 있으면서, Test를 실행하는 것이 명령어 한 줄로 간단해져 자주 확인하게 된다는 장점을 가진다. 또한 Pre-Commit 등에 추가하여 Test를 통과한 코드만 공유하도록 하는 것도 가능한데, 이를 통해 코드의 안정성이 높아지는 효과도 있다. 이러한 장점들은 특히 복잡한 프로그램을 만든다거나 배포를 염두해 둔 프로그램이라면 더욱 명확해진다.

물론 이렇게 Test를 자동화하는 것에는 단점도 있는데, 대표적으로는 Test Code를 작성하는 것 자체가 부담스럽다는 것이다. Test Code까지 생각하게 되면 사실상 작성하는 코드의 양이 2배가 되고, 그에 따라 체감하는 개발 속도 또한 느려져 답답하게 때문이다. 이러한 점 때문에 어느 정도 수준까지 Test를 진행할 것인가에 대해서는 개발자들 사이에서도 갑론을박이 있지만 개인적으로는 Test Code를 작성하는 시간만큼 그에 따른 효율적인 부분들이 있으므로 개발 속도가 크게 느려지지는 않는다고 생각한다. 오히려 버그를 찾기 위해 어느 부분이 문제인지 print 찍어가며 소모할 시간과 뜯겨나갈 머리카락을 생각하면 Test를 자동화하므로서 얻을 수 있는 이점이 더욱 많은 것 같다.

## Software Testing in Machine Learning

앞서 언급한 Software Testing 자동화의 장점들은 사실 특정 분야에 관한 것이라기 보다는 코딩과 관련된 영역이라면 분야에 구애받지 않고 누릴 수 있는 장점들이다. 머신러닝 분야 또한 어떠한 목적에서건 간에 코딩을 한다는 점에서 Test Code를 도입하는 것이 좋다고 생각하는데, 회사에서 강화학습 프로젝트를 진행하며 개인적으로 느낀 Test Code 작성의 장점으로는 다음과 같은 것들이 있다.

- 디버깅이 쉽고 빨라진다. 따라서 개발 프로세스 자체가 빨라진다.
- 리펙토링이 쉬워진다. 따라서 코드의 readability를 높이는 데에 도움이 된다.
- 다른 사람의 코드를 이해하기 쉬워진다. 따라서 팀 내 커뮤니케이션 비용이 줄어든다.

### 1. Test Code makes debugging easier

머신러닝에서 Test Code가 중요하고 또 필수적이라고 생각하는 첫 번째 이유는 학습이 잘 되지 않았을 때 Search Space를 줄여준다는 것에 있다. 강화학습 프로젝트를 진행한다고 하면 가장 먼저 하는 일 중 하나가 Agent와 상호작용하는 환경(시뮬레이터)를 만들거나, 이를 Agent와 연결하는 작업이다. 이때 Test Code를 잘 작성해두고 이에 따라 검증을 완료한 상태라면 모델이 학습되지 않더라도 환경과 관련된 부분에 대해선 디버깅을 할 필요가 없어진다.

### 2. Test Code makes refactoring easier

Refactoring은 기존 코드의 기능은 그대로 유지하면서 코드의 Maintinability 혹은 Readability를 높이는 작업이라고 할 수 있다. 하지만 코드만 두고 본다면 변경이 생긴 것이므로 Refactoring를 진행한 후에 제대로 동작하는지 검증해야하는데, 이것이 쉽지만은 않다. 이때 Test Code를 미리 만들어두었다면 코드 변경 후에도 검증하는 것이 매우 쉬워지고, 기능적으로 변경이 있는지 빠르게 확인할 수 있다. 결과적으로는 Refactoring에 소요되는 비용을 줄여주어 코드의 질을 높이는 데에 기여하게 된다.

### 3. Test Code reduces communication costs

Test Code를 잘 작성해두게 되면 다른 사람이 내가 작성한 코드를 이해하는 데에도 많은 도움이 된다. Software Testing의 한 종류인 Unit Test의 목적은 특정 부분이 의도대로 동작하는지 확인하는 것이라고 할 수 있는데, 이를 반대로 이해하면 Test Case만 잘 확인하면 어떠한 의도를 가지고 작성된 코드인지, 나아가 전체 소스 코드에서 어떠한 기능을 담당하고 있는지 알 수 있다는 것이다. 이러한 점에서 잘 쓰인 Test Code는 코드의 모호성을 줄여주고,  코드와 관련된 팀원들 간의 커뮤니케이션 비용을 줄여주는 효과를 만들어낸다고 생각한다.

## Notes for writing Test Code

회사에서 Test Code를 작성하며 받은 동료들의 피드백과 개인적인 생각들을 정리해보니 다음과 같은 요소들을 고려하며 Test Code를 작성하면 좋을 것 같다. 여기서 언급하는 요소들은 모두 Python으로 강화학습 프로젝트를 진행하면서 느낀 점이라는 것을 밝힌다.

##### 1. Test Code가 Test 대상에 종속되면 안 된다

쉽게 말해 Test Case를 작성할 때에는 소스 코드를 최대한 사용하지 않아야 한다. 예를 들면 어떤 Class의 Method들을 검증한다고 하면 해당 Class의 Attribute와 Method를 사용하는 것을 지양하는 식이다. 다만 이렇게 Test 대상과 분리를 하려하면 자연스럽게 Test Code를 위한 하드 코딩이 늘어난다. 이것이 작성 시에는 다소 부담이 되지만 이상적인 데이터 형태를 명시적으로 보여주어 이후 코드를 이해하는 데에 도움이 되기도 하므로 반드시 나쁘다고 볼 필요는 없다고 생각한다.

##### 2. Test Case는 최대한 잘게 쪼개어주는 것이 좋다

한 Test Case 내에는 하나의 assert만 두는 것이 이상적이다. 물론 Test Code 또한 관리의 대상이기 때문에 assert를 하나씩만 두기 위해 중복을 만드는 것은 비효율적이다. 하지만 한 Test Case에서 다루는 assert가 많아지면 많아질수록 Test의 결과를 이해하는 데에 많은 시간이 들어가게 되기 때문에 적절하게 관리하는 것이 중요하다.

##### 3. 함수를 검증한다면 입출력 검증은 필수다

함수는 결국 어떤 입력이 주어졌을 때 원하는 출력 값을 반환해야 한다. 따라서 입출력을 검증하는 것이 필수적인데, 이와 관련하여 다음과 같은 사항들을 고려하는 것이 좋다.

- 입력의 범위, 입력의 타입이 정해져 있다면 이에 대한 check가 필요하다.
- 가능한 Edge Case 입력을 list-up 하고 모두 검증할 수 있도록 한다.
- Method의 경우에는 중간에 Attribute를 변경하기도 하는데, 이에 대해서도 출력과 마찬가지로 검증한다.

##### 4. Test Case마다 그 목적이 무엇인지 Docstring을 명확히 작성해야 한다

Test Case마다 Docstring으로 무엇을 검증하기 위한 것이며, 입력과 출력은 어떠해야 한다는 것을 명시해주는 것이 좋다.

##### 5. Test Case만 보고도 어떻게 동작하는지 이해할 수 있어야 한다

Test Case의 첫 번째 목적은 작성한 코드를 검증하는 것이지만 마지막 목적은 작성한 코드를 쉽게 이해하는 데에 있다. 따라서 Test Case를 작성할 때에도 처음 코드를 보는 사람이 쉽게 이해할 수 있을지에 대한 고민이 필요하다.

##### 6. Test Code도 유지 보수의 대상이다

Test Code 또한 유지 보수의 대상이며, 새로운 기능을 추가하거나 기존 기능에 변경이 생기면 그에 맞추어 업데이트 되어야 한다. 따라서 Test Code를 작성하는 것 또한 효율성을 위한 조정의 대상이 될 수 있어야 한다. 이러한 점에서 'Test Covarage를 80% 이상으로 끌어올려야 한다'와 같는 규칙들은 지양하는 것이 좋다고 생각하며, 적어도 팀원들 간의 적절한 수준이라는 협의가 수반되어야 한다고 본다.
